<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Datos | Sistema MEAL +PaZion</title>
    <link rel="stylesheet" href="css/main.css?v=6">
    <style>
        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .signature-canvas {
            width: 100%;
            height: 200px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: #1A0D36;
            touch-action: none;
        }

        .photo-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.02);
            margin-top: var(--space-sm);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar"></aside>

        <main class="main-content">
            <header class="topbar"></header>

            <div class="page-wrapper">
                <div class="flex justify-between items-center" style="margin-bottom: var(--space-xl);">
                    <div>
                        <h1 class="text-gradient">Captura de Monitoreo</h1>
                        <p class="text-secondary">Registro de indicadores en campo</p>
                    </div>
                    <div class="flex items-center gap-sm">
                        <span class="text-sm fw-600">Paso <span id="currentStepNum">1</span> de 3</span>
                    </div>
                </div>

                <!-- STEP 1: Selecci√≥n de Indicador -->
                <div id="step1" class="step active">
                    <div class="card">
                        <h2 style="margin-bottom: var(--space-lg);">Seleccione el Indicador</h2>
                        <div class="form-group">
                            <label class="form-label">Eje Estrat√©gico</label>
                            <select id="ejeSelector" class="form-control">
                                <option value="">-- Seleccione un Eje --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Indicador</label>
                            <select id="indicadorSelector" class="form-control" disabled>
                                <option value="">-- Primero seleccione un Eje --</option>
                            </select>
                        </div>
                        <div id="indMeta" class="alert alert-info hidden">
                            <strong>Meta Meta Anual:</strong> <span id="metaText"></span>
                        </div>
                        <div class="flex justify-end" style="margin-top: var(--space-xl);">
                            <button id="btnToStep2" class="btn btn-primary" disabled>Continuar a Instrucciones</button>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Capacitaci√≥n / Instrucciones -->
                <div id="step2" class="step">
                    <div class="card">
                        <h2 style="margin-bottom: var(--space-lg);">M√≥dulo de Capacitaci√≥n</h2>
                        <div class="flex flex-col gap-lg">
                            <div>
                                <h3 id="instTitle" class="text-gradient">Gu√≠a para el registro</h3>
                                <p id="instDef" class="text-secondary" style="margin-top: var(--space-sm);"></p>
                            </div>

                            <div class="grid grid-2">
                                <div style="text-align: center;">
                                    <div
                                        style="margin-bottom: var(--space-sm); color: var(--success); font-weight: 700;">
                                        ‚úÖ Correcto (Referencia)</div>
                                    <img src="https://placehold.co/400x250/064E3B/D1FAF0?text=Evidencia+Correcta"
                                        alt="Correcto"
                                        style="border-radius: var(--radius-md); border: 2px solid var(--success);">
                                </div>
                                <div style="text-align: center;">
                                    <div
                                        style="margin-bottom: var(--space-sm); color: var(--danger); font-weight: 700;">
                                        ‚ùå Incorrecto</div>
                                    <img src="https://placehold.co/400x250/450A0A/FECACA?text=Evidencia+Incorrecta"
                                        alt="Incorrecto"
                                        style="border-radius: var(--radius-md); border: 2px solid var(--danger);">
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <div class="form-check">
                                    <input type="checkbox" id="checkRead">
                                    <label for="checkRead"><strong>Confirmo que he le√≠do y comprendido las instrucciones
                                            de captura para este indicador.</strong></label>
                                </div>
                            </div>

                            <div class="flex justify-between" style="margin-top: var(--space-md);">
                                <button onclick="goToStep(1)" class="btn btn-ghost">Atr√°s</button>
                                <button id="btnToStep3" class="btn btn-primary" disabled>Iniciar Captura</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: Formulario de Registro -->
                <div id="step3" class="step">
                    <form id="captureForm">
                        <div class="grid grid-2">
                            <div class="card">
                                <h3 style="margin-bottom: var(--space-lg);">Datos del Registro</h3>
                                <div class="form-group">
                                    <label class="form-label">Valor del Indicador <small>(N√∫mero o Texto seg√∫n
                                            definici√≥n)</small></label>
                                    <input type="text" id="valorInput" class="form-control"
                                        placeholder="Ingrese el resultado..." required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Observaciones / Comentarios</label>
                                    <textarea id="obsInput" class="form-control"
                                        placeholder="Detalles adicionales del levantamiento..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Geolocalizaci√≥n (GPS)</label>
                                    <div class="flex items-center gap-md">
                                        <div id="gpsCoords" class="text-sm text-muted">A√∫n no capturado</div>
                                        <button type="button" id="btnGetGPS" class="btn btn-secondary btn-sm">üìç
                                            Capturar Ubicaci√≥n</button>
                                    </div>
                                    <div id="gpsStatusText" class="text-xs" style="margin-top: 5px;"></div>
                                </div>
                            </div>

                            <div class="card">
                                <h3 style="margin-bottom: var(--space-lg);">Evidencia y Firma</h3>
                                <div class="form-group">
                                    <label class="form-label">Evidencia Fotogr√°fica</label>
                                    <input type="file" id="photoInput" accept="image/*" class="hidden">
                                    <button type="button" onclick="document.getElementById('photoInput').click()"
                                        class="btn btn-ghost btn-full">üì∑ Cargar Foto</button>
                                    <div id="photoPreview" class="photo-preview">
                                        <span class="text-muted">Sin imagen cargada</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Firma del Beneficiario/T√©cnico</label>
                                    <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                                    <div class="flex justify-end" style="margin-top: 5px;">
                                        <button type="button" id="btnClearSignature" class="btn btn-ghost btn-sm">Borrar
                                            Firma</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between" style="margin-top: var(--space-xl);">
                            <button type="button" onclick="goToStep(2)" class="btn btn-ghost">Atr√°s</button>
                            <button type="submit" class="btn btn-primary btn-lg">üíæ Finalizar y Guardar</button>
                        </div>
                    </form>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        import { initUI, showToast } from './js/app.js?v=6';
        import { initDB, addData, ensureDataSeeded } from './js/db.js?v=6';
        import { SignaturePad } from './js/firma.js?v=6';
        import { getCurrentUser } from './js/auth.js?v=6';

        initUI();

        // ‚îÄ‚îÄ‚îÄ DATOS MAESTROS INCRUSTADOS (no dependen de IndexedDB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Esto garantiza que los ejes e indicadores SIEMPRE est√©n disponibles,
        // independientemente del estado del Service Worker o IndexedDB.
        const INDICADORES = [
            { id: 1, eje: 'Empoderamiento y Liderazgo Femenino', nombre: '√çndice de Autoconfianza', meta: '80% con aumento >3 puntos' },
            { id: 2, eje: 'Empoderamiento y Liderazgo Femenino', nombre: 'Agencia de Decisi√≥n', meta: '100% de las participantes' },
            { id: 3, eje: 'Empoderamiento y Liderazgo Femenino', nombre: 'Identificaci√≥n de Derechos', meta: '90% de las participantes' },
            { id: 4, eje: 'Construcci√≥n de Paz y Territorio', nombre: 'Percepci√≥n de Espacio Seguro', meta: '95% de percepci√≥n positiva' },
            { id: 5, eje: 'Construcci√≥n de Paz y Territorio', nombre: 'Resoluci√≥n de Conflictos', meta: 'Reducci√≥n del 50% en incidentes' },
            { id: 6, eje: 'Construcci√≥n de Paz y Territorio', nombre: 'V√≠nculo Intercultural', meta: '1 encuentro bimensual' },
            { id: 7, eje: 'Permanencia y Excelencia Deportiva', nombre: 'Tasa de Retenci√≥n', meta: '85% de retenci√≥n anual' },
            { id: 8, eje: 'Permanencia y Excelencia Deportiva', nombre: 'Desempe√±o Competitivo', meta: 'M√≠nimo 2 torneos anuales' },
            { id: 9, eje: 'Permanencia y Excelencia Deportiva', nombre: 'Escalamiento Deportivo', meta: '2-3 jugadoras por ciclo' }
        ];

        let sigPad;
        let selectedInd = null;
        let gpsData = null;

        // ‚îÄ‚îÄ‚îÄ POBLAR EJES INMEDIATAMENTE (s√≠ncrono, sin async) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        (function poblarEjes() {
            const ejes = [...new Set(INDICADORES.map(i => i.eje))];
            const ejeSel = document.getElementById('ejeSelector');
            ejes.forEach(eje => {
                const opt = document.createElement('option');
                opt.value = eje;
                opt.textContent = eje;
                ejeSel.appendChild(opt);
            });
        })();

        // Inicializar BD en background (solo para guardar capturas)
        initDB().then(() => ensureDataSeeded()).catch(err =>
            console.warn('BD no disponible, modo solo-formulario:', err)
        );

        // ‚îÄ‚îÄ‚îÄ SELECTORES DIN√ÅMICOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('ejeSelector').addEventListener('change', (e) => {
            const indSel = document.getElementById('indicadorSelector');
            const ejeValue = e.target.value;

            indSel.innerHTML = '<option value="">-- Seleccione un Indicador --</option>';
            if (ejeValue) {
                const filtered = INDICADORES.filter(i => i.eje === ejeValue);
                filtered.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i.id;
                    opt.textContent = i.nombre;
                    indSel.appendChild(opt);
                });
                indSel.disabled = false;
            } else {
                indSel.disabled = true;
            }
            selectedInd = null;
            document.getElementById('indMeta').classList.add('hidden');
            updateBtnStep2();
        });

        document.getElementById('indicadorSelector').addEventListener('change', (e) => {
            const id = parseInt(e.target.value);
            selectedInd = INDICADORES.find(i => i.id === id) || null;

            if (selectedInd) {
                document.getElementById('indMeta').classList.remove('hidden');
                document.getElementById('metaText').textContent = selectedInd.meta;
                document.getElementById('instTitle').textContent = `Gu√≠a: ${selectedInd.nombre}`;
                document.getElementById('instDef').innerHTML = `<strong>Definici√≥n:</strong> Mide el progreso del indicador base seg√∫n la meta institucional de ${selectedInd.meta}. Aseg√∫rese de que la evidencia cumpla con los est√°ndares de calidad MEAL.`;
            } else {
                document.getElementById('indMeta').classList.add('hidden');
            }
            updateBtnStep2();
        });

        function updateBtnStep2() {
            document.getElementById('btnToStep2').disabled = !selectedInd;
        }

        // ‚îÄ‚îÄ‚îÄ NAVEGACI√ìN DE PASOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.goToStep = (step) => {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            document.getElementById('currentStepNum').textContent = step;

            if (step === 3 && !sigPad) {
                setTimeout(() => { sigPad = new SignaturePad('signatureCanvas'); }, 100);
            }
        };

        document.getElementById('btnToStep2').addEventListener('click', () => goToStep(2));
        document.getElementById('checkRead').addEventListener('change', (e) => {
            document.getElementById('btnToStep3').disabled = !e.target.checked;
        });
        document.getElementById('btnToStep3').addEventListener('click', () => goToStep(3));

        // ‚îÄ‚îÄ‚îÄ GPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('btnGetGPS').addEventListener('click', () => {
            const status = document.getElementById('gpsStatusText');
            status.textContent = "Obteniendo ubicaci√≥n...";
            if (!navigator.geolocation) {
                status.textContent = "GPS no soportado en este navegador.";
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    gpsData = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
                    document.getElementById('gpsCoords').textContent =
                        `Lat: ${gpsData.lat.toFixed(6)}, Lng: ${gpsData.lng.toFixed(6)} (¬±${gpsData.acc.toFixed(1)}m)`;
                    status.textContent = "‚úÖ Ubicaci√≥n capturada correctamente.";
                    status.style.color = "var(--success)";
                },
                () => {
                    status.textContent = "‚ùå Error: Permiso denegado o se√±al d√©bil.";
                    status.style.color = "var(--danger)";
                }
            );
        });

        // ‚îÄ‚îÄ‚îÄ FOTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('photoInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('photoPreview').innerHTML = `<img src="${e.target.result}">`;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('btnClearSignature').addEventListener('click', () => {
            if (sigPad) sigPad.clear();
        });

        // ‚îÄ‚îÄ‚îÄ GUARDAR FORMULARIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('captureForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = getCurrentUser();

            if (!gpsData) {
                alert("Por favor capture la ubicaci√≥n GPS antes de continuar.");
                return;
            }
            if (sigPad.isEmpty()) {
                alert("La firma es obligatoria para validar el registro.");
                return;
            }

            const registro = {
                indicador_id: selectedInd.id,
                indicador_nombre: selectedInd.nombre,
                eje: selectedInd.eje,
                usuario_id: user?.id,
                usuario_nombre: user?.nombre,
                valor: document.getElementById('valorInput').value,
                observaciones: document.getElementById('obsInput').value,
                fecha: new Date().toISOString(),
                gps: gpsData,
                firma: sigPad.getDataUrl(),
                estado: 'Pendiente',
                sync_status: navigator.onLine ? 'Synced' : 'Pending'
            };

            try {
                await addData('capturas', registro);
                showToast("Registro guardado exitosamente" + (!navigator.onLine ? " (Offline)" : ""), "success");
                setTimeout(() => { window.location.href = 'dashboard.html'; }, 1500);
            } catch (error) {
                console.error(error);
                showToast("Error al guardar el registro", "error");
            }
        });
    </script>
</body>

</html>
