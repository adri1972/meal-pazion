<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Datos | Sistema MEAL +PaZion</title>
    <link rel="stylesheet" href="css/main.css?v=7">
    <style>
        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        /* ‚îÄ‚îÄ Slider de escala 1-10 ‚îÄ‚îÄ */
        .scale-input {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .scale-track {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .scale-track input[type=range] {
            flex: 1;
            accent-color: var(--purple-600);
            cursor: pointer;
            height: 6px;
        }

        .scale-value {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--grad-brand);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            padding: 0 2px;
        }

        /* ‚îÄ‚îÄ Tabla de participantes ‚îÄ‚îÄ */
        .participant-row {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            position: relative;
            animation: fadeInUp 0.2s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .participant-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
        }

        .participant-number {
            font-size: 12px;
            font-weight: 700;
            color: var(--purple-400);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .btn-remove {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #FCA5A5;
            border-radius: var(--radius-sm);
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-remove:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* ‚îÄ‚îÄ Resultado autom√°tico ‚îÄ‚îÄ */
        .resultado-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 700;
        }

        .resultado-pill.logrado {
            background: rgba(34, 197, 94, 0.15);
            color: #86EFAC;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .resultado-pill.no-logrado {
            background: rgba(239, 68, 68, 0.12);
            color: #FCA5A5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .resultado-pill.neutral {
            background: rgba(245, 158, 11, 0.12);
            color: #FDE68A;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* ‚îÄ‚îÄ Resumen sesi√≥n ‚îÄ‚îÄ */
        .resumen-kpi {
            text-align: center;
            padding: var(--space-lg);
            background: rgba(123, 53, 196, 0.1);
            border: 1px solid var(--border-accent);
            border-radius: var(--radius-xl);
        }

        .resumen-kpi .kpi-value {
            font-family: 'Outfit', sans-serif;
            font-size: 48px;
            font-weight: 800;
            background: var(--grad-brand);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .resumen-kpi .kpi-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .resumen-kpi .kpi-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .signature-canvas {
            width: 100%;
            height: 200px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: #F3F0FA;
            touch-action: none;
        }

        .photo-preview {
            width: 100%;
            height: 180px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.02);
            margin-top: var(--space-sm);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Binary (Si/No) */
        .binary-toggle {
            display: flex;
            gap: var(--space-sm);
        }

        .binary-option {
            flex: 1;
            padding: 10px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border);
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition);
            user-select: none;
        }

        .binary-option.si.selected {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.15);
            color: #86EFAC;
        }

        .binary-option.no.selected {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.15);
            color: #FCA5A5;
        }

        .binary-option:not(.selected) {
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar"></aside>
        <main class="main-content">
            <header class="topbar"></header>
            <div class="page-wrapper">

                <div class="flex justify-between items-center" style="margin-bottom: var(--space-xl);">
                    <div>
                        <h1 class="text-gradient">Captura de Monitoreo</h1>
                        <p class="text-secondary">Instrumento digital de campo ‚Äî +PaZion MEAL</p>
                    </div>
                    <div class="flex items-center gap-sm">
                        <span class="text-sm fw-600">Paso <span id="currentStepNum">1</span> de 3</span>
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     PASO 1: Selecci√≥n de Indicador
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="step1" class="step active">
                    <div class="card">
                        <h2 style="margin-bottom: var(--space-lg);">¬øQu√© vamos a medir hoy?</h2>
                        <div class="form-group">
                            <label class="form-label">Eje Estrat√©gico</label>
                            <select id="ejeSelector" class="form-control">
                                <option value="">-- Seleccione un Eje --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Indicador</label>
                            <select id="indicadorSelector" class="form-control" disabled>
                                <option value="">-- Primero seleccione un Eje --</option>
                            </select>
                        </div>
                        <div id="indInfo" class="hidden" style="margin-top: var(--space-md);">
                            <div class="alert alert-info" style="margin-bottom: 0;">
                                <div>
                                    <div style="font-weight:700; margin-bottom:4px;">üìã <span id="indNombre"></span>
                                    </div>
                                    <div style="font-size:13px;"><strong>Meta:</strong> <span id="indMeta"></span></div>
                                    <div style="font-size:13px; margin-top:4px;"><strong>C√≥mo se mide:</strong> <span
                                            id="indMetodo"></span></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end" style="margin-top: var(--space-xl);">
                            <button id="btnToStep2" class="btn btn-primary" disabled>Iniciar Encuesta ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     PASO 2: Encuesta Digital de Campo
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="step2" class="step">
                    <div class="card" style="margin-bottom: var(--space-lg);">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 id="surveyTitle" style="margin-bottom: 4px;"></h2>
                                <p id="surveyInstruccion" class="text-secondary" style="font-size:14px;"></p>
                            </div>
                            <span id="surveyBadge" class="badge badge-purple"></span>
                        </div>
                    </div>

                    <!-- Contenedor din√°mico de participantes -->
                    <div id="participantesContainer"></div>

                    <!-- Bot√≥n agregar -->
                    <button id="btnAgregarParticipante" class="btn btn-secondary btn-full"
                        style="margin-bottom: var(--space-lg);">
                        ‚ûï Agregar participante / registro
                    </button>

                    <!-- Resumen en tiempo real -->
                    <div id="resumenLive" class="card" style="margin-bottom: var(--space-lg); display:none;">
                        <h3 style="margin-bottom: var(--space-md);">üìä Resultado de la sesi√≥n</h3>
                        <div id="resumenContent"></div>
                    </div>

                    <div class="flex justify-between">
                        <button onclick="goToStep(1)" class="btn btn-ghost">‚Üê Atr√°s</button>
                        <button id="btnToStep3" class="btn btn-primary" disabled>Ver Resumen y Guardar ‚Üí</button>
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     PASO 3: Confirmaci√≥n, Evidencia y Firma
                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="step3" class="step">
                    <div class="grid grid-2" style="gap: var(--space-lg);">
                        <!-- Resumen KPI -->
                        <div>
                            <div class="card" style="margin-bottom: var(--space-lg);">
                                <h3 style="margin-bottom: var(--space-lg);">‚úÖ Resumen de la Sesi√≥n</h3>
                                <div id="resumenFinal"></div>
                            </div>
                            <div class="card">
                                <h3 style="margin-bottom: var(--space-lg);">üìç Geolocalizaci√≥n</h3>
                                <div class="flex items-center gap-md">
                                    <div id="gpsCoords" class="text-sm text-muted" style="flex:1;">A√∫n no capturado
                                    </div>
                                    <button type="button" id="btnGetGPS" class="btn btn-secondary btn-sm">üìç Capturar
                                        GPS</button>
                                </div>
                                <div id="gpsStatusText" class="text-xs" style="margin-top:5px;"></div>
                            </div>
                        </div>

                        <!-- Evidencia y firma -->
                        <div>
                            <div class="card" style="margin-bottom: var(--space-lg);">
                                <h3 style="margin-bottom: var(--space-lg);">üì∑ Evidencia Fotogr√°fica</h3>
                                <input type="file" id="photoInput" accept="image/*" class="hidden">
                                <button type="button" onclick="document.getElementById('photoInput').click()"
                                    class="btn btn-ghost btn-full">üì∑ Cargar Foto de la Sesi√≥n</button>
                                <div id="photoPreview" class="photo-preview">
                                    <span class="text-muted" style="font-size:13px;">Sin imagen cargada</span>
                                </div>
                            </div>
                            <div class="card">
                                <h3 style="margin-bottom: var(--space-lg);">‚úçÔ∏è Firma del T√©cnico</h3>
                                <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                                <div class="flex justify-end" style="margin-top:5px;">
                                    <button type="button" id="btnClearSignature"
                                        class="btn btn-ghost btn-sm">Borrar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between" style="margin-top: var(--space-xl);">
                        <button onclick="goToStep(2)" class="btn btn-ghost">‚Üê Atr√°s</button>
                        <button id="btnGuardar" class="btn btn-primary btn-lg">üíæ Guardar Sesi√≥n Completa</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        import { initUI, showToast } from './js/app.js?v=7';
        import { initDB, addData, ensureDataSeeded } from './js/db.js?v=7';
        import { SignaturePad } from './js/firma.js?v=7';
        import { getCurrentUser } from './js/auth.js?v=7';

        initUI();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURACI√ìN DE INDICADORES ‚Äî Preguntas espec√≠ficas por cada uno
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const INDICADORES = [
            {
                id: 1,
                eje: 'Empoderamiento y Liderazgo Femenino',
                nombre: '√çndice de Autoconfianza',
                meta: '80% con aumento >3 puntos',
                metodo: 'Encuesta de Entrada vs. Salida (escala 1-10)',
                tipo: 'escala',
                umbral: 3, // puntos de aumento para "logrado"
                metaPct: 80,
                instruccion: 'Registra el puntaje de seguridad personal de cada ni√±a (escala 1 a 10). Primero su puntuaci√≥n de l√≠nea base y luego la actual.',
                preguntaBase: '¬øQu√© tan segura se siente consigo misma? (antes del programa)',
                preguntaActual: '¬øQu√© tan segura se siente consigo misma? (ahora)',
            },
            {
                id: 2,
                eje: 'Empoderamiento y Liderazgo Femenino',
                nombre: 'Agencia de Decisi√≥n',
                meta: '100% de las participantes',
                metodo: 'Encuesta directa (S√≠/No)',
                tipo: 'binario',
                metaPct: 100,
                instruccion: 'Pregunta a cada participante: ¬øTomaste al menos una decisi√≥n importante por ti misma este mes?',
                pregunta: '¬øTomaste al menos una decisi√≥n importante por ti misma este mes?',
            },
            {
                id: 3,
                eje: 'Empoderamiento y Liderazgo Femenino',
                nombre: 'Identificaci√≥n de Derechos',
                meta: '90% de las participantes',
                metodo: 'Encuesta directa (S√≠/No)',
                tipo: 'binario',
                metaPct: 90,
                instruccion: 'Pregunta a cada participante: ¬øPuedes mencionar al menos 3 derechos que tienes como ni√±a/mujer?',
                pregunta: '¬øPuede mencionar al menos 3 de sus derechos como ni√±a/mujer?',
            },
            {
                id: 4,
                eje: 'Construcci√≥n de Paz y Territorio',
                nombre: 'Percepci√≥n de Espacio Seguro',
                meta: '95% de percepci√≥n positiva',
                metodo: 'Encuesta de percepci√≥n (escala 1-10)',
                tipo: 'escala',
                umbral: 7, // puntaje m√≠nimo para "percepci√≥n positiva"
                metaPct: 95,
                instruccion: 'Registra c√≥mo cada participante percibe el espacio del programa (1=nada seguro, 10=totalmente seguro).',
                preguntaActual: '¬øQu√© tan seguro y c√≥modo sientes el espacio del programa?',
                modoUnico: true, // solo puntaje actual, no base
            },
            {
                id: 5,
                eje: 'Construcci√≥n de Paz y Territorio',
                nombre: 'Resoluci√≥n de Conflictos',
                meta: 'Reducci√≥n del 50% en incidentes',
                metodo: 'Conteo de incidentes del per√≠odo',
                tipo: 'conteo',
                instruccion: 'Registra el n√∫mero total de incidentes de conflicto en el per√≠odo de reporte.',
                labelConteo: 'N√∫mero de incidentes reportados en este per√≠odo',
                labelAnterior: 'N√∫mero de incidentes en el per√≠odo anterior (referencia)',
                metaDescripcion: 'Meta: reducir al menos 50% vs. per√≠odo anterior',
            },
            {
                id: 6,
                eje: 'Construcci√≥n de Paz y Territorio',
                nombre: 'V√≠nculo Intercultural',
                meta: '1 encuentro bimensual',
                metodo: 'Conteo de encuentros interculturales realizados',
                tipo: 'conteo',
                instruccion: 'Registra el n√∫mero de encuentros interculturales realizados en el bimestre.',
                labelConteo: 'Encuentros interculturales realizados este bimestre',
                metaDescripcion: 'Meta: al menos 1 encuentro por bimestre',
            },
            {
                id: 7,
                eje: 'Permanencia y Excelencia Deportiva',
                nombre: 'Tasa de Retenci√≥n',
                meta: '85% de retenci√≥n anual',
                metodo: 'Conteo de activas vs. inscritas inicialmente',
                tipo: 'retencion',
                instruccion: 'Ingresa el total de jugadoras inscritas al inicio del per√≠odo y cu√°ntas siguen activas.',
                metaPct: 85,
            },
            {
                id: 8,
                eje: 'Permanencia y Excelencia Deportiva',
                nombre: 'Desempe√±o Competitivo',
                meta: 'M√≠nimo 2 torneos anuales',
                metodo: 'Conteo de torneos participados en el a√±o',
                tipo: 'conteo',
                instruccion: 'Registra el n√∫mero de torneos o competencias en los que el equipo ha participado este a√±o.',
                labelConteo: 'Torneos / competencias participadas este a√±o',
                metaDescripcion: 'Meta: m√≠nimo 2 torneos por a√±o',
            },
            {
                id: 9,
                eje: 'Permanencia y Excelencia Deportiva',
                nombre: 'Escalamiento Deportivo',
                meta: '2-3 jugadoras por ciclo',
                metodo: 'Conteo de jugadoras promovidas en el ciclo',
                tipo: 'conteo',
                instruccion: 'Registra cu√°ntas jugadoras fueron promovidas o escaladas a nivel superior en este ciclo.',
                labelConteo: 'Jugadoras promovidas / escaladas en este ciclo',
                metaDescripcion: 'Meta: entre 2 y 3 jugadoras por ciclo',
            },
        ];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ESTADO GLOBAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let sigPad;
        let selectedInd = null;
        let participantes = []; // datos recopilados en paso 2
        let gpsData = null;
        let conteoData = {}; // para indicadores tipo conteo/retencion

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PASO 1: Poblar ejes e indicadores
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        (function poblarEjes() {
            const ejes = [...new Set(INDICADORES.map(i => i.eje))];
            const ejeSel = document.getElementById('ejeSelector');
            ejes.forEach(eje => {
                const opt = document.createElement('option');
                opt.value = eje;
                opt.textContent = eje;
                ejeSel.appendChild(opt);
            });
        })();

        initDB().then(() => ensureDataSeeded()).catch(err =>
            console.warn('BD no disponible:', err)
        );

        document.getElementById('ejeSelector').addEventListener('change', e => {
            const indSel = document.getElementById('indicadorSelector');
            const ejeValue = e.target.value;
            indSel.innerHTML = '<option value="">-- Seleccione un Indicador --</option>';
            selectedInd = null;
            document.getElementById('indInfo').classList.add('hidden');
            document.getElementById('btnToStep2').disabled = true;

            if (ejeValue) {
                const filtered = INDICADORES.filter(i => i.eje === ejeValue);
                filtered.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i.id;
                    opt.textContent = i.nombre;
                    indSel.appendChild(opt);
                });
                indSel.disabled = false;
            } else {
                indSel.disabled = true;
            }
        });

        document.getElementById('indicadorSelector').addEventListener('change', e => {
            const id = parseInt(e.target.value);
            selectedInd = INDICADORES.find(i => i.id === id) || null;
            if (selectedInd) {
                document.getElementById('indInfo').classList.remove('hidden');
                document.getElementById('indNombre').textContent = selectedInd.nombre;
                document.getElementById('indMeta').textContent = selectedInd.meta;
                document.getElementById('indMetodo').textContent = selectedInd.metodo;
                document.getElementById('btnToStep2').disabled = false;
            } else {
                document.getElementById('indInfo').classList.add('hidden');
                document.getElementById('btnToStep2').disabled = true;
            }
        });

        document.getElementById('btnToStep2').addEventListener('click', () => {
            participantes = [];
            conteoData = {};
            configurarPaso2();
            goToStep(2);
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PASO 2: Configurar encuesta seg√∫n tipo de indicador
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function configurarPaso2() {
            const ind = selectedInd;
            document.getElementById('surveyTitle').textContent = ind.nombre;
            document.getElementById('surveyInstruccion').textContent = ind.instruccion;
            document.getElementById('surveyBadge').textContent = `Eje ${Math.ceil(ind.id / 3)}`;

            const container = document.getElementById('participantesContainer');
            container.innerHTML = '';

            const tipos = {
                escala: () => renderEncuestaEscala(),
                binario: () => renderEncuestaBinario(),
                conteo: () => renderEncuestaConteo(),
                retencion: () => renderEncuestaRetencion(),
            };

            const btnAgregar = document.getElementById('btnAgregarParticipante');

            if (ind.tipo === 'conteo' || ind.tipo === 'retencion') {
                btnAgregar.style.display = 'none';
                tipos[ind.tipo]();
            } else {
                btnAgregar.style.display = '';
                btnAgregar.textContent = '‚ûï Agregar otra participante';
                agregarParticipante();
            }

            actualizarResumenLive();
        }

        function agregarParticipante() {
            const ind = selectedInd;
            if (ind.tipo === 'escala') renderEncuestaEscala(true);
            else if (ind.tipo === 'binario') renderEncuestaBinario(true);
        }

        document.getElementById('btnAgregarParticipante').addEventListener('click', () => {
            agregarParticipante();
            actualizarResumenLive();
        });

        // ‚îÄ‚îÄ Encuesta tipo ESCALA (1-10) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderEncuestaEscala(append = false) {
            const ind = selectedInd;
            const idx = document.querySelectorAll('.participant-row').length;
            const pIdx = idx; // √≠ndice para participantes[]
            participantes.push({ nombre: '', base: 5, actual: 5 });

            const div = document.createElement('div');
            div.className = 'participant-row';
            div.dataset.idx = pIdx;

            const tieneBase = !ind.modoUnico;

            div.innerHTML = `
                <div class="participant-header">
                    <span class="participant-number">Participante #${pIdx + 1}</span>
                    ${pIdx > 0 ? `<button class="btn-remove" onclick="removeParticipante(${pIdx})">‚úï Quitar</button>` : ''}
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre (opcional)</label>
                    <input type="text" class="form-control p-nombre" placeholder="Nombre o c√≥digo de la participante"
                        oninput="updateParticipante(${pIdx}, 'nombre', this.value)">
                </div>
                ${tieneBase ? `
                <div class="form-group">
                    <label class="form-label">${ind.preguntaBase}</label>
                    <div class="scale-input">
                        <div class="scale-track">
                            <span style="font-size:12px; color:var(--text-muted);">1</span>
                            <input type="range" min="1" max="10" value="5" class="p-base"
                                oninput="updateSlider(this,'base-val-${pIdx}','base',(${pIdx}))">
                            <span style="font-size:12px; color:var(--text-muted);">10</span>
                            <div class="scale-value" id="base-val-${pIdx}">5</div>
                        </div>
                        <div class="scale-labels"><span>Muy baja</span><span>Alta</span></div>
                    </div>
                </div>` : ''}
                <div class="form-group">
                    <label class="form-label">${ind.preguntaActual || ind.preguntaBase}</label>
                    <div class="scale-input">
                        <div class="scale-track">
                            <span style="font-size:12px; color:var(--text-muted);">1</span>
                            <input type="range" min="1" max="10" value="5" class="p-actual"
                                oninput="updateSlider(this,'actual-val-${pIdx}','actual',(${pIdx}))">
                            <span style="font-size:12px; color:var(--text-muted);">10</span>
                            <div class="scale-value" id="actual-val-${pIdx}">5</div>
                        </div>
                        <div class="scale-labels"><span>Muy baja</span><span>Alta</span></div>
                    </div>
                </div>
                <div id="resultado-${pIdx}"></div>
            `;
            document.getElementById('participantesContainer').appendChild(div);
            updateResultado(pIdx);
        }

        window.updateSlider = (input, valId, campo, pIdx) => {
            const v = parseInt(input.value);
            document.getElementById(valId).textContent = v;
            updateParticipante(pIdx, campo, v);
            updateResultado(pIdx);
            actualizarResumenLive();
        };

        window.updateParticipante = (idx, campo, valor) => {
            if (participantes[idx]) participantes[idx][campo] = valor;
            if (campo === 'base' || campo === 'actual') updateResultado(idx);
        };

        function updateResultado(pIdx) {
            const ind = selectedInd;
            if (!ind || ind.tipo !== 'escala') return;
            const p = participantes[pIdx];
            if (!p) return;
            const el = document.getElementById(`resultado-${pIdx}`);
            if (!el) return;

            if (ind.modoUnico) {
                const logrado = p.actual >= ind.umbral;
                el.innerHTML = `<span class="resultado-pill ${logrado ? 'logrado' : 'no-logrado'}">
                    ${logrado ? '‚úÖ Percepci√≥n positiva' : '‚ö†Ô∏è Percepci√≥n baja'} (${p.actual}/10)</span>`;
            } else {
                const aumento = p.actual - p.base;
                const logrado = aumento >= ind.umbral;
                el.innerHTML = `<span class="resultado-pill ${aumento > 0 ? (logrado ? 'logrado' : 'neutral') : 'no-logrado'}">
                    ${aumento > 0 ? '+' : ''}${aumento} puntos ‚Äî ${logrado ? '‚úÖ Meta lograda' : aumento > 0 ? '‚¨ÜÔ∏è Con mejora' : '‚ÜîÔ∏è Sin avance'}</span>`;
            }
        }

        // ‚îÄ‚îÄ Encuesta tipo BINARIO (Si/No) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderEncuestaBinario(append = false) {
            const ind = selectedInd;
            const pIdx = document.querySelectorAll('.participant-row').length;
            participantes.push({ nombre: '', respuesta: null });

            const div = document.createElement('div');
            div.className = 'participant-row';
            div.dataset.idx = pIdx;
            div.innerHTML = `
                <div class="participant-header">
                    <span class="participant-number">Participante #${pIdx + 1}</span>
                    ${pIdx > 0 ? `<button class="btn-remove" onclick="removeParticipante(${pIdx})">‚úï Quitar</button>` : ''}
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre (opcional)</label>
                    <input type="text" class="form-control" placeholder="Nombre o c√≥digo"
                        oninput="updateParticipante(${pIdx},'nombre',this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">${ind.pregunta}</label>
                    <div class="binary-toggle">
                        <div class="binary-option si" id="bin-si-${pIdx}" onclick="selectBinary(${pIdx}, true)">‚úÖ S√≠</div>
                        <div class="binary-option no" id="bin-no-${pIdx}" onclick="selectBinary(${pIdx}, false)">‚ùå No</div>
                    </div>
                </div>
            `;
            document.getElementById('participantesContainer').appendChild(div);
        }

        window.selectBinary = (pIdx, valor) => {
            participantes[pIdx].respuesta = valor;
            document.getElementById(`bin-si-${pIdx}`).className = `binary-option si${valor === true ? ' selected' : ''}`;
            document.getElementById(`bin-no-${pIdx}`).className = `binary-option no${valor === false ? ' selected' : ''}`;
            actualizarResumenLive();
        };

        // ‚îÄ‚îÄ Encuesta tipo CONTEO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderEncuestaConteo() {
            const ind = selectedInd;
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div class="alert alert-info" style="margin-bottom: var(--space-lg);">${ind.instruccion}</div>
                ${ind.labelAnterior ? `
                <div class="form-group">
                    <label class="form-label">${ind.labelAnterior}</label>
                    <input type="number" min="0" id="conteoAnterior" class="form-control" value="0" placeholder="0"
                        oninput="updateConteo()">
                </div>` : ''}
                <div class="form-group">
                    <label class="form-label">${ind.labelConteo}</label>
                    <input type="number" min="0" id="conteoActual" class="form-control" value="0" placeholder="0"
                        oninput="updateConteo()">
                </div>
                <div class="form-group">
                    <label class="form-label">Observaciones</label>
                    <textarea id="conteoObs" class="form-control" placeholder="Contexto, detalles del per√≠odo..."></textarea>
                </div>
                <p class="form-hint">${ind.metaDescripcion || ''}</p>
            `;
            document.getElementById('participantesContainer').appendChild(div);
            document.getElementById('btnToStep3').disabled = false;
        }

        window.updateConteo = () => {
            const actual = parseInt(document.getElementById('conteoActual')?.value || 0);
            const anterior = parseInt(document.getElementById('conteoAnterior')?.value || 0);
            const obs = document.getElementById('conteoObs')?.value || '';
            conteoData = { actual, anterior, obs };
            actualizarResumenLive();
        };

        // ‚îÄ‚îÄ Encuesta tipo RETENCI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderEncuestaRetencion() {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div class="alert alert-info" style="margin-bottom: var(--space-lg);">${selectedInd.instruccion}</div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Jugadoras inscritas al inicio</label>
                        <input type="number" min="1" id="retTotal" class="form-control" value="1" oninput="updateConteo()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jugadoras activas actualmente</label>
                        <input type="number" min="0" id="retActivas" class="form-control" value="0" oninput="updateConteo()">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Observaciones</label>
                    <textarea id="conteoObs" class="form-control" placeholder="Razones de bajas, novedades..."></textarea>
                </div>
            `;
            document.getElementById('participantesContainer').appendChild(div);
            document.getElementById('btnToStep3').disabled = false;
        }

        // ‚îÄ‚îÄ Quitar participante ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.removeParticipante = (pIdx) => {
            participantes.splice(pIdx, 1);
            configurarPaso2(); // re-render
        };

        // ‚îÄ‚îÄ Resumen en vivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function actualizarResumenLive() {
            const ind = selectedInd;
            if (!ind) return;
            const resumenDiv = document.getElementById('resumenLive');
            const resumenContent = document.getElementById('resumenContent');
            const btn = document.getElementById('btnToStep3');

            let html = '';
            let puedeGuardar = false;

            if (ind.tipo === 'escala') {
                const validos = participantes.filter(p =>
                    ind.modoUnico ? p.actual >= 1 : (p.base >= 1 && p.actual >= 1)
                );
                const logrados = validos.filter(p =>
                    ind.modoUnico ? p.actual >= ind.umbral : (p.actual - p.base) >= ind.umbral
                );
                const pct = validos.length > 0 ? Math.round(logrados.length / validos.length * 100) : 0;
                const alMeta = pct >= ind.metaPct;

                html = `<div class="resumen-kpi">
                    <div class="kpi-value">${pct}%</div>
                    <div class="kpi-label">${ind.modoUnico ? 'con percepci√≥n positiva' : 'con aumento ‚â•' + ind.umbral + ' puntos'}</div>
                    <div class="kpi-meta">Meta: ${ind.metaPct}% ‚Äî ${logrados.length} de ${validos.length} participantes ‚Äî ${alMeta ? '‚úÖ META LOGRADA' : '‚ö†Ô∏è Por debajo de meta'}</div>
                </div>`;
                puedeGuardar = validos.length > 0;

            } else if (ind.tipo === 'binario') {
                const respondidos = participantes.filter(p => p.respuesta !== null);
                const positivos = respondidos.filter(p => p.respuesta === true);
                const pct = respondidos.length > 0 ? Math.round(positivos.length / respondidos.length * 100) : 0;

                html = `<div class="resumen-kpi">
                    <div class="kpi-value">${pct}%</div>
                    <div class="kpi-label">respondieron S√≠</div>
                    <div class="kpi-meta">Meta: ${ind.metaPct}% ‚Äî ${positivos.length} de ${respondidos.length} ‚Äî ${pct >= ind.metaPct ? '‚úÖ META LOGRADA' : '‚ö†Ô∏è Por debajo de meta'}</div>
                </div>`;
                puedeGuardar = respondidos.length > 0;

            } else if (ind.tipo === 'conteo') {
                const val = conteoData.actual || 0;
                html = `<div class="resumen-kpi">
                    <div class="kpi-value">${val}</div>
                    <div class="kpi-label">${ind.labelConteo}</div>
                    <div class="kpi-meta">${ind.metaDescripcion || ''}</div>
                </div>`;
                puedeGuardar = true;

            } else if (ind.tipo === 'retencion') {
                const total = parseInt(document.getElementById('retTotal')?.value || 0);
                const activas = parseInt(document.getElementById('retActivas')?.value || 0);
                const pct = total > 0 ? Math.round(activas / total * 100) : 0;
                html = `<div class="resumen-kpi">
                    <div class="kpi-value">${pct}%</div>
                    <div class="kpi-label">tasa de retenci√≥n</div>
                    <div class="kpi-meta">Meta: ${ind.metaPct}% ‚Äî ${activas} de ${total} activas ‚Äî ${pct >= ind.metaPct ? '‚úÖ META LOGRADA' : '‚ö†Ô∏è Por debajo de meta'}</div>
                </div>`;
                conteoData = { actual: activas, total, obs: document.getElementById('conteoObs')?.value || '' };
                puedeGuardar = total > 0;
            }

            if (html) {
                resumenDiv.style.display = '';
                resumenContent.innerHTML = html;
            }
            btn.disabled = !puedeGuardar;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PASO 3: Preparar resumen final
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.getElementById('btnToStep3').addEventListener('click', () => {
            document.getElementById('resumenFinal').innerHTML =
                document.getElementById('resumenContent').innerHTML;
            goToStep(3);
        });

        // GPS
        document.getElementById('btnGetGPS').addEventListener('click', () => {
            const status = document.getElementById('gpsStatusText');
            status.textContent = 'Obteniendo ubicaci√≥n...';
            if (!navigator.geolocation) { status.textContent = 'GPS no soportado.'; return; }
            navigator.geolocation.getCurrentPosition(
                pos => {
                    gpsData = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
                    document.getElementById('gpsCoords').textContent =
                        `Lat: ${gpsData.lat.toFixed(6)}, Lng: ${gpsData.lng.toFixed(6)} (¬±${gpsData.acc.toFixed(1)}m)`;
                    status.textContent = '‚úÖ Ubicaci√≥n capturada.';
                    status.style.color = 'var(--success)';
                },
                () => { status.textContent = '‚ùå Permiso denegado.'; status.style.color = 'var(--danger)'; }
            );
        });

        // Foto
        document.getElementById('photoInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('photoPreview').innerHTML = `<img src="${e.target.result}">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Firma
        document.getElementById('btnClearSignature').addEventListener('click', () => {
            if (sigPad) sigPad.clear();
        });

        // ‚îÄ‚îÄ Guardar Sesi√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('btnGuardar').addEventListener('click', async () => {
            const user = getCurrentUser();
            let firma = null;

            if (!sigPad) {
                sigPad = new SignaturePad('signatureCanvas');
            }
            if (!sigPad.isEmpty()) {
                firma = sigPad.getDataUrl();
            }

            const fotoEl = document.getElementById('photoPreview').querySelector('img');
            const foto = fotoEl ? fotoEl.src : null;

            const sesion = {
                indicador_id: selectedInd.id,
                indicador_nombre: selectedInd.nombre,
                eje: selectedInd.eje,
                tipo: selectedInd.tipo,
                usuario_id: user?.id,
                usuario_nombre: user?.nombre,
                fecha: new Date().toISOString(),
                participantes: selectedInd.tipo === 'escala' || selectedInd.tipo === 'binario' ? participantes : [],
                conteo: conteoData,
                gps: gpsData,
                firma,
                foto,
                estado: 'Pendiente',
                sync_status: navigator.onLine ? 'Synced' : 'Pending',
            };

            try {
                await addData('capturas', sesion);
                showToast('‚úÖ Sesi√≥n guardada exitosamente' + (!navigator.onLine ? ' (Offline)' : ''), 'success');
                setTimeout(() => { window.location.href = 'dashboard.html'; }, 1800);
            } catch (err) {
                console.error(err);
                showToast('‚ùå Error al guardar', 'error');
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NAVEGACI√ìN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.goToStep = (step) => {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            document.getElementById('currentStepNum').textContent = step;

            if (step === 3 && !sigPad) {
                setTimeout(() => { sigPad = new SignaturePad('signatureCanvas'); }, 150);
            }
        };
    </script>
</body>

</html>