<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Sistema MEAL +PaZion</title>
    <link rel="stylesheet" href="css/main.css?v=12-analisis">
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar"></aside>

        <main class="main-content">
            <header class="topbar"></header>

            <div class="page-wrapper">
                <div class="flex justify-between items-center" style="margin-bottom: var(--space-xl);">
                    <div>
                        <h1 class="text-gradient">Resumen Global</h1>
                        <p class="text-secondary">Estado de los indicadores de la Fundaci√≥n +PaZion</p>
                    </div>
                    <div class="flex gap-sm">
                        <button class="btn btn-secondary btn-sm" onclick="location.reload()">
                            <span>üîÑ Actualizar</span>
                        </button>
                        <button class="btn btn-primary" id="btnNuevaCaptura">
                            <span>‚ûï Nueva Captura</span>
                        </button>
                    </div>
                </div>

                <!-- Global Stats Cards -->
                <div class="grid grid-4" style="margin-bottom: var(--space-2xl);">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(123,53,196,0.1); color: var(--purple-400);">üìà
                        </div>
                        <div class="stat-value" id="globalAvance">0%</div>
                        <div class="stat-label">Avance Meta Global</div>
                        <div class="stat-change text-muted" id="globalCambio">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(46,158,122,0.1); color: var(--green-400);">üë•
                        </div>
                        <div class="stat-value" id="totalParticipantes">0</div>
                        <div class="stat-label">Principales Beneficiarios</div>
                        <div class="stat-change text-muted">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(245,158,11,0.1); color: var(--warning);">üìç</div>
                        <div class="stat-value" id="totalComunidades">0</div>
                        <div class="stat-label">Comunidades Impactadas</div>
                        <div class="stat-change text-muted">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(59,130,246,0.1); color: var(--info);">üì°</div>
                        <div class="stat-value" id="pendientesSync">0</div>
                        <div class="stat-label">Registros Pendientes Sync</div>
                        <div class="stat-change text-muted" id="syncStatus">Al d√≠a</div>
                    </div>
                </div>

                <!-- Projects Progress -->
                <h2 style="margin-bottom: var(--space-lg);">Progreso por Eje Estrat√©gico</h2>
                <div class="grid grid-3" id="proyectosGrid">
                    <!-- Skeleton loading -->
                    <div class="card skeleton" style="height: 200px;"></div>
                    <div class="card skeleton" style="height: 200px;"></div>
                    <div class="card skeleton" style="height: 200px;"></div>
                </div>

                <div class="divider"></div>

                <div class="grid grid-2">
                    <!-- Recent Captures -->
                    <div class="card" style="grid-column: 1 / -1;">
                        <div class="card-header">
                            <h3 class="card-title">√öltimas Capturas en Campo</h3>
                            <a href="validacion.html" class="text-sm text-gradient fw-600">Ver todo</a>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Indicador</th>
                                        <th>Fecha</th>
                                        <th>Valor</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="recentCaptures">
                                    <tr>
                                        <td colspan="4" class="text-center">Cargando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Visualizaciones Chart.js y Alertas -->
                    <div class="card" style="grid-column: 1 / -1;">
                        <div class="card-header">
                            <h3 class="card-title">Distribuci√≥n Visual de Impacto</h3>
                        </div>
                        <div class="grid grid-2" style="gap: 2rem; margin-top: 1rem;">
                            <!-- Gr√°fico de Dona -->
                            <div style="position: relative; height: 250px; display: flex; justify-content: center;">
                                <canvas id="chartEjes"></canvas>
                            </div>
                            <!-- Gr√°fico de Barras -->
                            <div style="position: relative; height: 250px;">
                                <canvas id="chartEstados"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-3" style="margin-bottom: var(--space-2xl);">
                    <!-- Alertas Din√°micas (Reemplazando est√°ticas) -->
                    <div class="card" style="grid-column: 1 / -1;">
                        <div class="card-header">
                            <h3 class="card-title">Alertas Inteligentes de Monitoreo</h3>
                        </div>
                        <div class="flex flex-col gap-md" id="alertasInteligentes">
                            <div class="alert alert-info">Calculando desempe√±o de indicadores desde la base de datos
                                local...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Cargar Motor Gr√°fico Offline Seguro -->
    <script src="js/chart.min.js"></script>

    <script type="module">
        import { initUI, showToast } from './js/app.js?v=12-analisis';
        import { initDB, getAllData, ensureDataSeeded } from './js/db.js?v=12-analisis';

        // Inicializar UI y Auth
        initUI();
        console.log('Sistema cargado - Versi√≥n v15-ultrasharp');

        async function loadDashboardData() {
            console.log('Iniciando carga de datos del Dashboard...');
            const grid = document.getElementById('proyectosGrid');

            try {
                await initDB();
                console.log('DB inicializada.');

                await ensureDataSeeded();
                console.log('Sembrado verificado.');

                const indicadores = await getAllData('indicadores');
                const capturas = await getAllData('capturas');

                console.log(`Datos obtenidos: ${indicadores.length} indicadores, ${capturas.length} capturas.`);

                // --- C√°lculos Globales ---
                const totalCapturas = capturas.length;
                const pendientesSync = capturas.filter(c => c.sync_status === 'Pending').length;

                let totalParticipantes = 0;
                const comunidadesUnicas = new Set();
                let capturasExitosas = 0;

                capturas.forEach(c => {
                    if (c.gps && c.gps.lat) {
                        comunidadesUnicas.add(`${c.gps.lat.toFixed(2)},${c.gps.lng.toFixed(2)}`);
                    }

                    if (c.tipo === 'retencion' && c.conteo && c.conteo.total) {
                        totalParticipantes += c.conteo.total;
                    } else if ((c.tipo === 'escala' || c.tipo === 'binario') && c.participantes) {
                        totalParticipantes += c.participantes.length;
                    }

                    if (c.estado === 'Aprobado') capturasExitosas++;
                });

                const metaCapturasGlobal = 100;
                const avanceGlobal = Math.min(100, Math.round((totalCapturas / metaCapturasGlobal) * 100));

                // Actualizar UI
                document.getElementById('globalAvance').textContent = `${avanceGlobal}%`;
                document.getElementById('totalParticipantes').textContent = totalParticipantes;
                document.getElementById('totalComunidades').textContent = Math.max(1, comunidadesUnicas.size + (totalCapturas > 0 ? 1 : 0));

                const syncEl = document.getElementById('pendientesSync');
                const syncStatusEl = document.getElementById('syncStatus');
                syncEl.textContent = pendientesSync;
                if (pendientesSync > 0) {
                    syncEl.style.color = 'var(--warning)';
                    syncStatusEl.textContent = 'Requiere conexi√≥n';
                } else {
                    syncEl.style.color = 'var(--info)';
                    syncStatusEl.textContent = 'Al d√≠a';
                }

                // --- Agrupar indicadores por eje ---
                const ejes = {};
                indicadores.forEach(ind => {
                    if (!ejes[ind.eje]) ejes[ind.eje] = [];
                    ejes[ind.eje].push(ind);
                });

                grid.innerHTML = Object.entries(ejes).map(([eje, inds]) => {
                    const capturasDelEje = capturas.filter(c => c.eje === eje).length;
                    const metaEje = inds.length * 5;
                    const avanceEje = Math.min(100, Math.round((capturasDelEje / metaEje) * 100)) || 0;

                    let objetivo = "";
                    if (eje === 'Empoderamiento y Liderazgo Femenino')
                        objetivo = "Fortalecer la agencia individual y colectiva de las ni√±as participantes.";
                    else if (eje === 'Construcci√≥n de Paz y Territorio')
                        objetivo = "Fomentar la cohesi√≥n social y la reducci√≥n de riesgos en zonas de conflicto.";
                    else if (eje === 'Permanencia y Excelencia Deportiva')
                        objetivo = "Garantizar la continuidad del proceso formativo y el desarrollo t√©cnico.";

                    return `
                    <div class="card">
                        <div class="card-header">
                            <span class="badge badge-purple">${eje}</span>
                        </div>
                        <h3 style="margin-bottom: 4px;">${eje}</h3>
                        <p class="text-xs text-muted" style="margin-bottom: var(--space-md); line-height: 1.4;">
                            ${objetivo}
                        </p>
                        <div class="progress-container">
                            <div class="progress-header">
                                <span class="progress-label">Avance Eje</span>
                                <span class="progress-value">${avanceEje}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width: ${avanceEje}%"></div>
                            </div>
                        </div>
                        <p class="text-sm text-muted" style="margin-top: var(--space-md);">
                            ${inds.length} indicadores activos. (${capturasDelEje} registros)
                        </p>
                        <button class="btn btn-ghost btn-sm btn-full" style="margin-top: var(--space-md);" onclick="location.href='captura.html?eje=${encodeURIComponent(eje)}'">
                            Ver Indicadores
                        </button>
                    </div>
                `}).join('');

                // --- L√≥gica Visual de Gr√°ficos (Chart.js) ---
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js no est√° cargado.');
                    throw new Error('Motor de gr√°ficos no disponible.');
                }

                const participantesPorEje = {
                    'Empoderamiento y Liderazgo Femenino': 0,
                    'Construcci√≥n de Paz y Territorio': 0,
                    'Permanencia y Excelencia Deportiva': 0
                };

                const estadosPorEje = {
                    'Empoderamiento y Liderazgo Femenino': { Aprobado: 0, Borrador: 0, Rechazado: 0 },
                    'Construcci√≥n de Paz y Territorio': { Aprobado: 0, Borrador: 0, Rechazado: 0 },
                    'Permanencia y Excelencia Deportiva': { Aprobado: 0, Borrador: 0, Rechazado: 0 }
                };

                capturas.forEach(c => {
                    let sumaParcial = 0;
                    if (c.tipo === 'retencion' && c.conteo && c.conteo.total) {
                        sumaParcial = c.conteo.total;
                    } else if ((c.tipo === 'escala' || c.tipo === 'binario') && c.participantes) {
                        sumaParcial = c.participantes.length;
                    }

                    if (participantesPorEje[c.eje] !== undefined) participantesPorEje[c.eje] += sumaParcial;
                    if (estadosPorEje[c.eje] && estadosPorEje[c.eje][c.estado] !== undefined) {
                        estadosPorEje[c.eje][c.estado]++;
                    }
                });

                const colors = ['#7B35C4', '#2E9E7A', '#F5A623'];

                const ctxDona = document.getElementById('chartEjes').getContext('2d');
                new Chart(ctxDona, {
                    type: 'doughnut',
                    data: {
                        labels: ['Empoderamiento', 'Paz', 'Permanencia'],
                        datasets: [{
                            data: Object.values(participantesPorEje),
                            backgroundColor: colors,
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#4B5563', font: { family: 'Inter' } } }
                        },
                        cutout: '70%'
                    }
                });

                const ctxBarras = document.getElementById('chartEstados').getContext('2d');
                new Chart(ctxBarras, {
                    type: 'bar',
                    data: {
                        labels: ['Empoderamiento', 'Paz', 'Permanencia'],
                        datasets: [
                            { label: 'Aprobados', data: Object.values(estadosPorEje).map(e => e.Aprobado), backgroundColor: '#2E9E7A', borderRadius: 4 },
                            { label: 'Borradores', data: Object.values(estadosPorEje).map(e => e.Borrador), backgroundColor: '#F5A623', borderRadius: 4 },
                            { label: 'Rechazados', data: Object.values(estadosPorEje).map(e => e.Rechazado), backgroundColor: '#EF4444', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#E5E7EB' }, ticks: { stepSize: 1, color: '#4B5563' } },
                            x: { grid: { display: false }, ticks: { color: '#4B5563', font: { family: 'Inter' } } }
                        },
                        plugins: { legend: { position: 'bottom', labels: { color: '#4B5563', font: { family: 'Inter' } } } }
                    }
                });

                // --- L√≥gica Alertas Inteligentes ---
                const alertasDiv = document.getElementById('alertasInteligentes');
                let htmlAlertas = '';

                if (avanceGlobal >= 80) {
                    htmlAlertas += `<div class="alert alert-success"><strong>üèÜ ¬°Excelente trabajo!</strong> Has superado el 80% de la meta global.</div>`;
                } else if (avanceGlobal < 30 && totalCapturas > 0) {
                    htmlAlertas += `<div class="alert alert-warning"><strong>‚ö†Ô∏è Atenci√≥n:</strong> El avance global es bajo (${avanceGlobal}%).</div>`;
                }

                const capturasRechazadas = capturas.filter(c => c.estado === 'Rechazado').length;
                if (capturasRechazadas > 0) {
                    htmlAlertas += `<div class="alert alert-danger"><strong>üõë Acci√≥n requerida:</strong> Tienes ${capturasRechazadas} formulario(s) rechazado(s).</div>`;
                }

                if (totalCapturas === 0) {
                    htmlAlertas += `<div class="alert alert-info"><strong>üëã ¬°Bienvenido!</strong> Realiza tu primera captura de datos para empezar.</div>`;
                } else if (pendientesSync >= 5) {
                    htmlAlertas += `<div class="alert alert-warning"><strong>‚òÅÔ∏è Pendientes:</strong> Tienes ${pendientesSync} registros sin sincronizar.</div>`;
                } else if (capturasRechazadas === 0 && totalCapturas > 0) {
                    htmlAlertas += `<div class="alert alert-info"><strong>‚úì Todo en orden:</strong> Los datos fluyen normalmente.</div>`;
                }
                alertasDiv.innerHTML = htmlAlertas;

                // --- Cargar capturas recientes reales ---
                const recentBody = document.getElementById('recentCaptures');
                if (capturas.length === 0) {
                    recentBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No hay capturas recientes.</td></tr>`;
                } else {
                    const recientes = [...capturas].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);
                    recentBody.innerHTML = recientes.map(c => {
                        let badgeClass = 'badge-warning';
                        if (c.estado === 'Aprobado') badgeClass = 'badge-success';
                        if (c.estado === 'Rechazado') badgeClass = 'badge-danger';

                        let valorVisual = '-';
                        if (c.conteo) valorVisual = `<strong>${c.conteo.total}</strong> participantes`;
                        else if (c.participantes) valorVisual = `<strong>${c.participantes.length}</strong> participantes`;

                        return `
                        <tr>
                            <td class="fw-500">${c.indicador_nombre}</td>
                            <td class="text-sm text-muted">${new Date(c.fecha).toLocaleDateString('es-ES')}</td>
                            <td class="text-center">${valorVisual}</td>
                            <td><span class="badge ${badgeClass}">${c.estado}</span></td>
                        </tr>
                    `}).join('');
                }
            } catch (error) {
                console.error('Error cargando el dashboard:', error);
                grid.innerHTML = `
                    <div class="card" style="grid-column: span 3; border: 2px dashed var(--danger); background: rgba(239, 68, 68, 0.05);">
                        <div class="text-center" style="padding: var(--space-xl);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                            <h3 class="text-danger">Error al cargar datos</h3>
                            <p class="text-secondary">${error.message || 'Error interno de IndexedDB o Red.'}</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="location.reload()">Reintentar</button>
                        </div>
                    </div>
                `;
            }
        }

        loadDashboardData();

        document.getElementById('btnNuevaCaptura')?.addEventListener('click', () => {
            window.location.href = 'captura.html';
        });
    </script>
</body>

</html>