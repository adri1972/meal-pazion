<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes | Sistema MEAL +PaZion</title>
    <link rel="stylesheet" href="css/main.css?v=4">
    <!-- jspdf and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .progress-segment {
            height: 8px;
            border-radius: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-top: 4px;
        }

        .progress-segment-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple-600), var(--purple-400));
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .ind-row-eje {
            font-size: 11px;
            color: var(--text-muted);
            background: rgba(123, 53, 196, 0.08);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .logro-num {
            font-weight: 800;
            font-size: 16px;
            background: linear-gradient(135deg, var(--purple-400), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-2xl);
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: var(--space-md);
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar"></aside>

        <main class="main-content">
            <header class="topbar"></header>

            <div class="page-wrapper">
                <div class="flex justify-between items-center" style="margin-bottom: var(--space-xl);">
                    <div>
                        <h1 class="text-gradient">Generaci√≥n de Reportes</h1>
                        <p class="text-secondary">Consolidado institucional de indicadores y capturas de campo</p>
                    </div>
                    <button class="btn btn-primary" id="btnExportPDF">
                        <span>üìÑ Exportar PDF Institucional</span>
                    </button>
                </div>

                <!-- Filtros -->
                <div class="card" style="margin-bottom: var(--space-xl);">
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">Rango de Fechas</label>
                            <select id="filterDate" class="form-control">
                                <option value="all">Todo el per√≠odo</option>
                                <option value="month">Este Mes</option>
                                <option value="quarter">Este Trimestre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Eje Estrat√©gico</label>
                            <select id="filterEje" class="form-control">
                                <option value="all">Todos los Ejes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado de Validaci√≥n</label>
                            <select id="filterStatus" class="form-control">
                                <option value="all">Todos</option>
                                <option value="Aprobado">Solo Aprobados</option>
                                <option value="Pendiente">Pendientes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- √Årea de Reporte (para PDF) -->
                <div id="reportContent" class="card" style="padding: var(--space-2xl);">
                    <!-- Encabezado Institucional -->
                    <div class="text-center" style="margin-bottom: var(--space-2xl);">
                        <img src="assets/img/logo.png" alt="+PaZion"
                            style="height: 60px; margin: 0 auto var(--space-md); filter: grayscale(1) brightness(2);"
                            onerror="this.src='https://placehold.co/150x60/0D0718/7B35C4?text=+PaZion'">
                        <h2 style="font-size: 24px; color: var(--text-primary);">Reporte Consolidado MEAL</h2>
                        <p class="text-muted">Fundaci√≥n +PaZion / Goles de Vida</p>
                        <div id="reportMeta" class="text-sm" style="margin-top: var(--space-sm);">
                            Generado el: <span id="genDate"></span>
                        </div>
                    </div>

                    <!-- KPIs Globales -->
                    <div class="grid grid-4" style="margin-bottom: var(--space-2xl);">
                        <div
                            style="background: rgba(123,53,196,0.08); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border); text-align: center;">
                            <div style="font-size: 28px; font-weight: 800; color: var(--purple-400);" id="kpiTotal">0
                            </div>
                            <div
                                style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">
                                Total Capturas</div>
                        </div>
                        <div
                            style="background: rgba(46,158,122,0.08); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border); text-align: center;">
                            <div style="font-size: 28px; font-weight: 800; color: var(--green-400);" id="kpiAprobados">0
                            </div>
                            <div
                                style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">
                                Aprobados</div>
                        </div>
                        <div
                            style="background: rgba(245,158,11,0.08); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border); text-align: center;">
                            <div style="font-size: 28px; font-weight: 800; color: var(--warning);" id="kpiPendientes">0
                            </div>
                            <div
                                style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">
                                Pendientes</div>
                        </div>
                        <div
                            style="background: rgba(59,130,246,0.08); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border); text-align: center;">
                            <div style="font-size: 28px; font-weight: 800; color: var(--info);" id="kpiIndicadores">0
                            </div>
                            <div
                                style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-top: 4px;">
                                Indicadores con Datos</div>
                        </div>
                    </div>

                    <!-- Tabla de Indicadores -->
                    <h3 style="margin-bottom: var(--space-lg);">Matriz de Indicadores</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Indicador</th>
                                    <th>Eje</th>
                                    <th>Meta (A√±o 1)</th>
                                    <th>Capturas</th>
                                    <th>Aprobados</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                <!-- Din√°mico -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Historial de Capturas Recientes -->
                    <div id="recentCapturesSection" style="margin-top: var(--space-2xl);">
                        <h3 style="margin-bottom: var(--space-lg);">Historial de Capturas en Campo</h3>
                        <div id="capturesList"></div>
                    </div>

                    <div
                        style="margin-top: var(--space-3xl); border-top: 1px solid var(--border); padding-top: var(--space-md);">
                        <p class="text-xs text-muted text-center">Nuestro sistema MEAL no solo mide n√∫meros; mide la
                            transformaci√≥n de la subjetividad pol√≠tica de las ni√±as en el Cauca y el Valle.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initUI, showToast } from './js/app.js?v=4';
        import { initDB, getAllData, ensureDataSeeded } from './js/db.js?v=4';

        initUI();

        let allCaptures = [];
        let indicadores = [];

        async function initReport() {
            await initDB();
            await ensureDataSeeded();
            allCaptures = await getAllData('capturas');
            indicadores = await getAllData('indicadores');

            // Llenar filtro de ejes
            const ejes = [...new Set(indicadores.map(i => i.eje))];
            const ejeFilter = document.getElementById('filterEje');
            ejes.forEach(eje => {
                const opt = document.createElement('option');
                opt.value = eje;
                opt.textContent = eje;
                ejeFilter.appendChild(opt);
            });

            document.getElementById('genDate').textContent = new Date().toLocaleDateString('es-ES', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            applyFilters();
        }

        function getFilteredCaptures() {
            const dateVal = document.getElementById('filterDate').value;
            const statusVal = document.getElementById('filterStatus').value;
            const ejeVal = document.getElementById('filterEje').value;

            let filtered = [...allCaptures];

            // Filtro de estado
            if (statusVal !== 'all') filtered = filtered.filter(c => c.estado === statusVal);

            // Filtro de fecha
            if (dateVal === 'month') {
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                filtered = filtered.filter(c => new Date(c.fecha) >= monthAgo);
            } else if (dateVal === 'quarter') {
                const quarterAgo = new Date();
                quarterAgo.setMonth(quarterAgo.getMonth() - 3);
                filtered = filtered.filter(c => new Date(c.fecha) >= quarterAgo);
            }

            // Filtro de eje (por indicador)
            if (ejeVal !== 'all') {
                const indsInEje = indicadores.filter(i => i.eje === ejeVal).map(i => i.id);
                filtered = filtered.filter(c => indsInEje.includes(c.indicador_id));
            }

            return filtered;
        }

        function applyFilters() {
            const ejeVal = document.getElementById('filterEje').value;
            const filteredCaptures = getFilteredCaptures();

            let filteredInds = indicadores;
            if (ejeVal !== 'all') filteredInds = indicadores.filter(i => i.eje === ejeVal);

            // KPIs
            const aprobados = filteredCaptures.filter(c => c.estado === 'Aprobado');
            const pendientes = filteredCaptures.filter(c => c.estado === 'Pendiente');
            const withData = new Set(filteredCaptures.map(c => c.indicador_id)).size;
            document.getElementById('kpiTotal').textContent = filteredCaptures.length;
            document.getElementById('kpiAprobados').textContent = aprobados.length;
            document.getElementById('kpiPendientes').textContent = pendientes.length;
            document.getElementById('kpiIndicadores').textContent = withData;

            // Tabla de indicadores
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = filteredInds.map(ind => {
                const caps = filteredCaptures.filter(c => c.indicador_id === ind.id);
                const app = caps.filter(c => c.estado === 'Aprobado');
                const tieneDatos = caps.length > 0;
                return `
                    <tr>
                        <td><strong>${ind.nombre}</strong></td>
                        <td><span class="text-xs text-muted">${ind.eje}</span></td>
                        <td class="text-sm">${ind.meta}</td>
                        <td class="text-center"><strong>${caps.length}</strong></td>
                        <td class="text-center"><span style="color: var(--green-400); font-weight: 700;">${app.length}</span></td>
                        <td>
                            <span class="badge ${tieneDatos ? (app.length > 0 ? 'badge-success' : 'badge-warning') : ''}">
                                ${tieneDatos ? (app.length > 0 ? `‚úÖ ${app.length} Aprobado${app.length > 1 ? 's' : ''}` : '‚è≥ Pendiente Revisi√≥n') : '‚ÄîSin Registros'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Historial de capturas recientes
            const capturesList = document.getElementById('capturesList');
            if (filteredCaptures.length === 0) {
                capturesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No hay capturas con los filtros seleccionados.</p>
                        <p class="text-sm">Cree una nueva captura desde la secci√≥n <a href="captura.html" class="text-gradient fw-600">Captura de Datos</a>.</p>
                    </div>
                `;
            } else {
                const recent = filteredCaptures.slice(-10).reverse();
                capturesList.innerHTML = `
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√©cnico</th>
                                    <th>Indicador</th>
                                    <th>Valor</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recent.map(c => {
                    const ind = indicadores.find(i => i.id === c.indicador_id);
                    return `
                                        <tr>
                                            <td>${c.usuario_nombre || '‚Äî'}</td>
                                            <td>${ind ? ind.nombre : 'Desconocido'}</td>
                                            <td><strong>${c.valor}</strong></td>
                                            <td class="text-sm text-muted">${new Date(c.fecha).toLocaleDateString('es-ES')}</td>
                                            <td><span class="badge ${c.estado === 'Aprobado' ? 'badge-success' : c.estado === 'Rechazado' ? 'badge-danger' : 'badge-warning'}">${c.estado}</span></td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        // Eventos de filtros
        document.getElementById('filterEje').addEventListener('change', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterDate').addEventListener('change', applyFilters);

        // Exportar PDF
        document.getElementById('btnExportPDF').addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const content = document.getElementById('reportContent');

            showToast("Generando PDF institucional...", "info");

            html2canvas(content, {
                backgroundColor: '#0D0718',
                scale: 2,
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 595.28;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                doc.save('Reporte_MEAL_Pazion_' + new Date().toISOString().split('T')[0] + '.pdf');
                showToast("PDF descargado con √©xito", "success");
            });
        });

        initReport();
    </script>
</body>

</html>