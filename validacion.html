<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validaci√≥n de Datos | Sistema MEAL +PaZion</title>
    <link rel="stylesheet" href="css/main.css?v=11.3">
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar"></aside>

        <main class="main-content">
            <header class="topbar"></header>

            <div class="page-wrapper">
                <div class="flex justify-between items-center" style="margin-bottom: var(--space-xl);">
                    <div>
                        <h1 class="text-gradient">Bandeja de Validaci√≥n</h1>
                        <p class="text-secondary">Gesti√≥n y archivo de registros levantados en campo</p>
                    </div>
                </div>

                <!-- TABS -->
                <div
                    style="border-bottom: 1px solid var(--border); margin-bottom: var(--space-xl); display: flex; gap: var(--space-lg);">
                    <button id="tabPendientes" class="tab-btn active"
                        style="background:none; border:none; padding:10px 0; font-size:16px; font-weight:700; color:var(--purple-400); border-bottom:3px solid var(--purple-400); cursor:pointer;">Pendientes
                        de Revisi√≥n</button>
                    <button id="tabHistorial" class="tab-btn"
                        style="background:none; border:none; padding:10px 0; font-size:16px; font-weight:600; color:var(--text-muted); border-bottom:3px solid transparent; cursor:pointer;">Historial
                        Documental</button>
                </div>

                <!-- VISTA 1: PENDIENTES -->
                <div id="viewPendientes">
                    <div class="card">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>T√©cnico</th>
                                        <th>Indicador</th>
                                        <th>Fecha</th>
                                        <th>Valor</th>
                                        <th>Ubicaci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="validationList">
                                    <tr>
                                        <td colspan="6" class="text-center">Buscando registros pendientes...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VISTA 2: HISTORIAL -->
                <div id="viewHistorial" class="hidden">
                    <div class="card" style="margin-bottom: var(--space-lg);">
                        <div class="flex items-center gap-md">
                            <div class="form-group" style="margin-bottom: 0; flex: 1;">
                                <label class="form-label text-xs">Agrupar por Mes</label>
                                <select id="filterMonth" class="form-control">
                                    <option value="all">Todos los meses</option>
                                    <!-- Din√°mico -->
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0; flex: 1;">
                                <label class="form-label text-xs">Estado de Registro</label>
                                <select id="filterStatus" class="form-control">
                                    <option value="all">Todos (Aprobados y Rechazados)</option>
                                    <option value="Aprobado">Solo Aprobados ‚úÖ</option>
                                    <option value="Rechazado">Solo Rechazados ‚ùå</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="historialContainer">
                        <!-- El historial din√°mico se renderizar√° aqu√≠ -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Detalle -->
    <div id="detailModal" class="modal-overlay hidden">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title">Detalle del Registro</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Se llena din√°micamente -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="btnReject">Rechazar Registro</button>
                <button class="btn btn-success" id="btnApprove">Aprobar y Consolidar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initUI, showToast } from './js/app.js?v=11.3';
        import { initDB, getAllData, updateData, getDataById } from './js/db.js?v=11.3';

        initUI();

        let currentRecord = null;
        let records = [];
        let allProcessedRecords = [];

        // Tab Switching Logic
        const tabPendientes = document.getElementById('tabPendientes');
        const tabHistorial = document.getElementById('tabHistorial');
        const viewPendientes = document.getElementById('viewPendientes');
        const viewHistorial = document.getElementById('viewHistorial');

        tabPendientes.addEventListener('click', () => {
            tabPendientes.style.color = 'var(--purple-400)';
            tabPendientes.style.borderBottomColor = 'var(--purple-400)';
            tabPendientes.style.fontWeight = '700';
            tabHistorial.style.color = 'var(--text-muted)';
            tabHistorial.style.borderBottomColor = 'transparent';
            tabHistorial.style.fontWeight = '600';

            viewPendientes.classList.remove('hidden');
            viewHistorial.classList.add('hidden');
            loadData();
        });

        tabHistorial.addEventListener('click', () => {
            tabHistorial.style.color = 'var(--purple-400)';
            tabHistorial.style.borderBottomColor = 'var(--purple-400)';
            tabHistorial.style.fontWeight = '700';
            tabPendientes.style.color = 'var(--text-muted)';
            tabPendientes.style.borderBottomColor = 'transparent';
            tabPendientes.style.fontWeight = '600';

            viewPendientes.classList.add('hidden');
            viewHistorial.classList.remove('hidden');
            loadData();
        });

        async function loadData() {
            await initDB();
            const allCaptures = await getAllData('capturas');

            // Pendientes
            records = allCaptures.filter(c => c.estado === 'Pendiente' || c.estado === 'Borrador');

            // Historial (Aprobados y Rechazados)
            allProcessedRecords = allCaptures.filter(c => c.estado === 'Aprobado' || c.estado === 'Rechazado');

            renderPendientes();
            renderHistorial();
        }

        async function renderPendientes() {
            const tbody = document.getElementById('validationList');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 40px; color: var(--text-muted);">No hay registros pendientes de validaci√≥n.</td></tr>';
                return;
            }

            const indicadores = await getAllData('indicadores');

            tbody.innerHTML = records.map(r => {
                const ind = indicadores.find(i => i.id === r.indicador_id);
                // Si es modo viejo con r.valor, usar eso, si es nuevo, coger participantes o conteo
                let valToShow = r.valor || '-';
                if (r.conteo) valToShow = r.conteo.total + ' pers.';
                if (r.participantes) valToShow = r.participantes.length + ' pers.';

                return `
                    <tr>
                        <td>${r.usuario_nombre || 'T√©cnico'}</td>
                        <td>${ind ? ind.nombre : (r.indicador_nombre || 'Desconocido')}</td>
                        <td>${new Date(r.fecha).toLocaleDateString()}</td>
                        <td><strong>${valToShow}</strong></td>
                        <td><span class="text-sm">üìç ${r.gps ? r.gps.lat.toFixed(4) : 'N/A'}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="window.viewDetail(${r.id})">Revisar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function renderHistorial() {
            const container = document.getElementById('historialContainer');
            const monthFilter = document.getElementById('filterMonth').value;
            const statusFilter = document.getElementById('filterStatus').value;

            // Extraer y poblar filtros de mes
            const months = [...new Set(allProcessedRecords.map(r => {
                const d = new Date(r.fecha);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();

            const monthSelect = document.getElementById('filterMonth');
            if (monthSelect.options.length <= 1) {
                months.forEach(m => {
                    const [y, mo] = m.split('-');
                    const date = new Date(y, mo - 1, 1);
                    const label = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = label.charAt(0).toUpperCase() + label.slice(1);
                    monthSelect.appendChild(opt);
                });
            }

            const indicadores = await getAllData('indicadores');

            // Agrupar por Mes
            const grouped = {};

            allProcessedRecords.forEach(r => {
                const d = new Date(r.fecha);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

                // Aplicar Filtros
                if (monthFilter !== 'all' && monthKey !== monthFilter) return;
                if (statusFilter !== 'all' && r.estado !== statusFilter) return;

                if (!grouped[monthKey]) grouped[monthKey] = { Aprobado: [], Rechazado: [] };
                grouped[monthKey][r.estado].push(r);
            });

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = `
                    <div class="card text-center" style="padding: var(--space-2xl);">
                        <div style="font-size:48px; margin-bottom: var(--space-md);">üìÅ</div>
                        <h3 class="text-secondary">Sin Historial en este filtro</h3>
                        <p class="text-muted">No se encontraron capturas procesadas para el filtro seleccionado.</p>
                    </div>`;
                return;
            }

            // Renderizar carpetas por mes
            let html = '';
            for (const monthKey of Object.keys(grouped).sort().reverse()) {
                const d = new Date(monthKey + '-01T00:00:00');
                const monthName = d.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                const aprobados = grouped[monthKey]['Aprobado'];
                const rechazados = grouped[monthKey]['Rechazado'];

                if (aprobados.length === 0 && rechazados.length === 0) continue;

                html += `
                    <div class="card" style="margin-bottom: var(--space-lg); border-left: 4px solid var(--purple-400);">
                        <h3 style="margin-bottom: var(--space-md); text-transform: capitalize; color: var(--text-primary);">
                            üìÖ ${monthName}
                        </h3>
                `;

                const renderTable = (lista, estado) => {
                    if (lista.length === 0) return '';
                    const badgeClass = estado === 'Aprobado' ? 'badge-success' : 'badge-danger';
                    const icon = estado === 'Aprobado' ? '‚úÖ' : '‚ùå';

                    return `
                        <div style="margin-top: var(--space-md);">
                            <div class="flex items-center gap-sm" style="margin-bottom: 8px;">
                                <span class="badge ${badgeClass}" style="font-size:13px;">${icon} ${estado}s (${lista.length})</span>
                            </div>
                            <div class="table-wrapper" style="background: rgba(255,255,255,0.02); border-radius: var(--radius-md);">
                                <table style="font-size: 13px;">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Indicador</th>
                                            <th>T√©cnico</th>
                                            <th>Valor</th>
                                            <th>Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${lista.map(r => {
                        const ind = indicadores.find(i => i.id === r.indicador_id);
                        let valToShow = r.valor || '-';
                        if (r.conteo) valToShow = r.conteo.total + ' pers.';
                        if (r.participantes) valToShow = r.participantes.length + ' pers.';

                        return `
                                            <tr>
                                                <td class="text-muted">${new Date(r.fecha).toLocaleDateString()}</td>
                                                <td><strong>${ind ? ind.nombre : (r.indicador_nombre || 'Desc.')}</strong></td>
                                                <td>${r.usuario_nombre || 'T√©cnico'}</td>
                                                <td>${valToShow}</td>
                                                <td><button class="btn btn-ghost btn-sm" onclick="window.viewProcessedDetail(${r.id})">Ver ‚Üí</button></td>
                                            </tr>
                                            `;
                    }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                };

                html += renderTable(aprobados, 'Aprobado');
                html += renderTable(rechazados, 'Rechazado');

                html += `</div>`;
            }

            container.innerHTML = html;
        }

        document.getElementById('filterMonth').addEventListener('change', renderHistorial);
        document.getElementById('filterStatus').addEventListener('change', renderHistorial);

        window.viewDetail = async (id) => {
            currentRecord = records.find(r => r.id === id);
            openDetailModal(currentRecord, true);
        };

        window.viewProcessedDetail = async (id) => {
            currentRecord = allProcessedRecords.find(r => r.id === id);
            openDetailModal(currentRecord, false);
        };

        async function openDetailModal(record, isPending) {
            const modal = document.getElementById('detailModal');
            const body = document.getElementById('modalBody');
            const footer = document.querySelector('.modal-footer');

            const indicadores = await getAllData('indicadores');
            const ind = indicadores.find(i => i.id === record.indicador_id);

            let valToShow = record.valor || '-';
            if (record.conteo) valToShow = record.conteo.total + ' participantes';
            if (record.participantes) valToShow = record.participantes.length + ' participantes guardados individualmente';

            let gpsHtml = 'Sin datos GPS';
            if (record.gps) {
                gpsHtml = `
                    <p class="text-sm"><strong>Coordenadas:</strong> ${record.gps.lat.toFixed(4)}, ${record.gps.lng.toFixed(4)}</p>
                    <a href="https://www.google.com/maps?q=${record.gps.lat},${record.gps.lng}" target="_blank" class="text-sm text-gradient fw-600">Ver en Google Maps ‚Üí</a>
                `;
            }

            body.innerHTML = `
                <div class="${record.estado === 'Rechazado' ? 'alert alert-danger' : record.estado === 'Aprobado' ? 'alert alert-success' : ''}" style="${isPending ? 'display:none;' : 'margin-bottom:var(--space-md);'}">
                    <strong>Estado actual: ${record.estado}</strong>
                    ${record.comentario_validacion ? `<br><span class="text-sm">Motivo/Nota: ${record.comentario_validacion}</span>` : ''}
                </div>
                <div class="grid grid-2">
                    <div>
                        <h4 class="text-muted text-sm uppercase fw-bold">Informaci√≥n General</h4>
                        <div style="margin-top: var(--space-sm);">
                            <p><strong>Indicador:</strong> ${ind ? ind.nombre : (record.indicador_nombre || '-')}</p>
                            <p><strong>Meta:</strong> ${ind ? ind.meta : '-'}</p>
                            <p><strong>Levantado por:</strong> ${record.usuario_nombre || 'T√©cnico'}</p>
                            <p><strong>Fecha:</strong> ${new Date(record.fecha).toLocaleString()}</p>
                            <p><strong>Valor Reportado:</strong> <span class="badge badge-purple" style="font-size: 14px;">${valToShow}</span></p>
                        </div>
                        
                        <h4 class="text-muted text-sm uppercase fw-bold" style="margin-top: var(--space-lg);">Observaciones de Campo</h4>
                        <p class="text-secondary">${record.observaciones || 'Sin observaciones'}</p>
                        
                    </div>
                    <div>
                        <h4 class="text-muted text-sm uppercase fw-bold">Evidencia Fotogr√°fica</h4>
                        <img src="${record.foto || record.firma || 'https://placehold.co/400x300/0D0718/7B35C4?text=Sin+Evidencia'}" style="width: 100%; border-radius: var(--radius-md); margin-top: 5px; max-height: 180px; object-fit: cover;">
                        
                        <h4 class="text-muted text-sm uppercase fw-bold" style="margin-top: var(--space-lg);">Ubicaci√≥n GPS</h4>
                        <div style="background: var(--bg-card); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border); margin-top: 5px;">
                            ${gpsHtml}
                        </div>
                    </div>
                </div>
                ${isPending ? `
                <div class="form-group" style="margin-top: var(--space-xl);">
                    <label class="form-label">Comentario de Revisi√≥n (Opcional)</label>
                    <textarea id="valComment" class="form-control" placeholder="Escriba el motivo del rechazo o nota de aprobaci√≥n..."></textarea>
                </div>
                ` : ''}
            `;

            if (isPending) {
                footer.style.display = 'flex';
            } else {
                footer.style.display = 'none';
            }

            modal.classList.remove('hidden');
        }

        window.closeModal = () => {
            document.getElementById('detailModal').classList.add('hidden');
        };

        document.getElementById('btnApprove').addEventListener('click', async () => {
            if (!currentRecord) return;
            const comment = document.getElementById('valComment') ? document.getElementById('valComment').value : '';

            currentRecord.estado = 'Aprobado';
            currentRecord.comentario_validacion = comment;

            await updateData('capturas', currentRecord);
            showToast("Registro aprobado correctamente", "success");
            closeModal();
            loadData();
        });

        document.getElementById('btnReject').addEventListener('click', async () => {
            if (!currentRecord) return;
            const comment = document.getElementById('valComment') ? document.getElementById('valComment').value : '';
            if (!comment) {
                alert("Por favor indique el motivo del rechazo en los comentarios.");
                return;
            }

            currentRecord.estado = 'Rechazado';
            currentRecord.comentario_validacion = comment;

            await updateData('capturas', currentRecord);
            showToast("Registro rechazado", "warning");
            closeModal();
            loadData();
        });

        loadData();
    </script>
</body>

</html>